<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>PreAnestesia ‚Äî Avalia√ß√£o Pr√©-Anest√©sica</title>
<meta name="description" content="App de avalia√ß√£o pr√©-anest√©sica digital">
<meta name="theme-color" content="#0a1628">
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-primary: #0a1628;
    --bg-secondary: #111d33;
    --bg-card: #162040;
    --bg-card-hover: #1a2850;
    --accent: #00d4aa;
    --accent-dim: #00a88a;
    --accent-glow: rgba(0, 212, 170, 0.15);
    --accent-glow-strong: rgba(0, 212, 170, 0.3);
    --danger: #ff5c6c;
    --danger-dim: rgba(255, 92, 108, 0.15);
    --warning: #ffb347;
    --warning-dim: rgba(255, 179, 71, 0.15);
    --text-primary: #e8edf5;
    --text-secondary: #8a9bc0;
    --text-muted: #5a6d94;
    --border: rgba(255, 255, 255, 0.06);
    --border-accent: rgba(0, 212, 170, 0.25);
    --radius: 16px;
    --radius-sm: 10px;
    --shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
    --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Background effect */
  body::before {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(ellipse at 30% 20%, rgba(0, 212, 170, 0.04) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(0, 100, 200, 0.03) 0%, transparent 50%);
    z-index: 0;
    pointer-events: none;
  }

  /* Header */
  .header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(10, 22, 40, 0.85);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    padding: 16px 20px;
  }

  .header-content {
    max-width: 600px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .logo-icon {
    width: 36px;
    height: 36px;
    background: linear-gradient(135deg, var(--accent), #0088cc);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
  }

  .logo-text {
    font-weight: 700;
    font-size: 18px;
    letter-spacing: -0.5px;
  }

  .logo-text span {
    color: var(--accent);
  }

  .header-actions {
    display: flex;
    gap: 8px;
  }

  .header-btn {
    width: 38px;
    height: 38px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--bg-card);
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    font-size: 16px;
  }

  .header-btn:hover {
    border-color: var(--border-accent);
    color: var(--accent);
    background: var(--accent-glow);
  }

  /* Main Container */
  .container {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
    position: relative;
    z-index: 1;
  }

  /* Progress */
  .progress-container {
    margin-bottom: 28px;
  }

  .progress-steps {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .progress-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    flex: 1;
    cursor: pointer;
    transition: var(--transition);
  }

  .step-dot {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 2px solid var(--text-muted);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 700;
    color: var(--text-muted);
    transition: var(--transition);
    position: relative;
  }

  .progress-step.active .step-dot {
    border-color: var(--accent);
    color: var(--accent);
    background: var(--accent-glow);
    box-shadow: 0 0 16px var(--accent-glow);
  }

  .progress-step.completed .step-dot {
    border-color: var(--accent);
    background: var(--accent);
    color: var(--bg-primary);
  }

  .step-label {
    font-size: 10px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    text-align: center;
    transition: var(--transition);
  }

  .progress-step.active .step-label,
  .progress-step.completed .step-label {
    color: var(--accent);
  }

  .progress-bar {
    height: 3px;
    background: var(--bg-card);
    border-radius: 2px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), #0088cc);
    border-radius: 2px;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Step Cards */
  .step-view {
    display: none;
    animation: fadeInUp 0.4s ease;
  }

  .step-view.active {
    display: block;
  }

  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .step-title {
    font-size: 24px;
    font-weight: 700;
    letter-spacing: -0.5px;
    margin-bottom: 4px;
  }

  .step-subtitle {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 24px;
  }

  /* Card */
  .card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 16px;
    transition: var(--transition);
  }

  .card:hover {
    border-color: rgba(255, 255, 255, 0.1);
  }

  .card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
  }

  .card-icon {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }

  .card-icon.teal { background: var(--accent-glow); }
  .card-icon.red { background: var(--danger-dim); }
  .card-icon.orange { background: var(--warning-dim); }
  .card-icon.blue { background: rgba(0, 136, 204, 0.15); }

  .card-title {
    font-size: 15px;
    font-weight: 600;
  }

  /* Form Elements */
  .form-group {
    margin-bottom: 16px;
  }

  .form-label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 8px;
  }

  .form-input, .form-select, .form-textarea {
    width: 100%;
    padding: 12px 16px;
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    transition: var(--transition);
    outline: none;
  }

  .form-input:focus, .form-select:focus, .form-textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }

  .form-input::placeholder, .form-textarea::placeholder {
    color: var(--text-muted);
  }

  .form-select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238a9bc0' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 14px center;
    padding-right: 36px;
    cursor: pointer;
  }

  .form-textarea {
    resize: vertical;
    min-height: 80px;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .form-row-3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
  }

  /* Checkbox / Toggle */
  .toggle-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .toggle-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 14px;
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: var(--transition);
    user-select: none;
  }

  .toggle-item:hover {
    border-color: rgba(255, 255, 255, 0.1);
  }

  .toggle-item.selected {
    border-color: var(--border-accent);
    background: var(--accent-glow);
  }

  .toggle-check {
    width: 22px;
    height: 22px;
    border-radius: 6px;
    border: 2px solid var(--text-muted);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    transition: var(--transition);
    flex-shrink: 0;
  }

  .toggle-item.selected .toggle-check {
    background: var(--accent);
    border-color: var(--accent);
    color: var(--bg-primary);
  }

  .toggle-text {
    font-size: 14px;
    color: var(--text-secondary);
    transition: var(--transition);
  }

  .toggle-item.selected .toggle-text {
    color: var(--text-primary);
  }

  /* Mallampati Visual Selector */
  .mallampati-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
  }

  .mallampati-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 14px 8px;
    background: var(--bg-primary);
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: var(--transition);
    text-align: center;
  }

  .mallampati-option:hover {
    border-color: rgba(255, 255, 255, 0.12);
  }

  .mallampati-option.selected {
    border-color: var(--accent);
    background: var(--accent-glow);
  }

  .mallampati-visual {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: var(--bg-card);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    position: relative;
    overflow: hidden;
  }

  .mallampati-option.selected .mallampati-visual {
    background: var(--accent-glow-strong);
  }

  .mallampati-label {
    font-size: 12px;
    font-weight: 700;
    color: var(--text-secondary);
    font-family: 'Space Mono', monospace;
  }

  .mallampati-option.selected .mallampati-label {
    color: var(--accent);
  }

  .mallampati-desc {
    font-size: 9px;
    color: var(--text-muted);
    line-height: 1.3;
  }

  /* ASA Selector */
  .asa-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }

  .asa-option {
    padding: 12px 8px;
    background: var(--bg-primary);
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: var(--transition);
    text-align: center;
  }

  .asa-option:hover {
    border-color: rgba(255, 255, 255, 0.12);
  }

  .asa-option.selected {
    border-color: var(--accent);
    background: var(--accent-glow);
  }

  .asa-number {
    font-family: 'Space Mono', monospace;
    font-size: 20px;
    font-weight: 700;
    color: var(--text-muted);
    transition: var(--transition);
  }

  .asa-option.selected .asa-number {
    color: var(--accent);
  }

  .asa-desc {
    font-size: 10px;
    color: var(--text-muted);
    margin-top: 4px;
    line-height: 1.3;
  }

  /* Navigation */
  .nav-buttons {
    display: flex;
    gap: 12px;
    margin-top: 28px;
    margin-bottom: 40px;
  }

  .btn {
    flex: 1;
    padding: 14px 24px;
    border-radius: var(--radius-sm);
    border: none;
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .btn-secondary {
    background: var(--bg-card);
    color: var(--text-secondary);
    border: 1px solid var(--border);
  }

  .btn-secondary:hover {
    background: var(--bg-card-hover);
    color: var(--text-primary);
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--accent), #00b896);
    color: var(--bg-primary);
    box-shadow: 0 4px 16px rgba(0, 212, 170, 0.3);
  }

  .btn-primary:hover {
    box-shadow: 0 6px 24px rgba(0, 212, 170, 0.45);
    transform: translateY(-1px);
  }

  .btn-danger {
    background: var(--danger-dim);
    color: var(--danger);
    border: 1px solid rgba(255, 92, 108, 0.2);
  }

  .btn-danger:hover {
    background: rgba(255, 92, 108, 0.25);
  }

  /* Summary / Review */
  .summary-section {
    margin-bottom: 20px;
  }

  .summary-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-muted);
    margin-bottom: 6px;
  }

  .summary-value {
    font-size: 15px;
    color: var(--text-primary);
    line-height: 1.6;
  }

  .summary-value.highlight {
    color: var(--accent);
    font-weight: 600;
    font-family: 'Space Mono', monospace;
  }

  .summary-divider {
    border: none;
    height: 1px;
    background: var(--border);
    margin: 16px 0;
  }

  .summary-tag {
    display: inline-block;
    padding: 4px 10px;
    background: var(--accent-glow);
    border: 1px solid var(--border-accent);
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    color: var(--accent);
    margin: 2px 4px 2px 0;
  }

  .summary-tag.red {
    background: var(--danger-dim);
    border-color: rgba(255, 92, 108, 0.25);
    color: var(--danger);
  }

  /* Patients List */
  .patient-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    margin-bottom: 10px;
    cursor: pointer;
    transition: var(--transition);
  }

  .patient-item:hover {
    border-color: var(--border-accent);
    background: var(--bg-card-hover);
  }

  .patient-info h4 {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .patient-info p {
    font-size: 12px;
    color: var(--text-secondary);
  }

  .patient-asa {
    font-family: 'Space Mono', monospace;
    font-weight: 700;
    font-size: 14px;
    color: var(--accent);
    padding: 6px 12px;
    background: var(--accent-glow);
    border-radius: 8px;
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
  }

  .empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  .empty-text {
    color: var(--text-muted);
    font-size: 15px;
  }

  /* Home Screen */
  .home-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 24px;
  }

  .stat-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 18px;
    text-align: center;
  }

  .stat-number {
    font-family: 'Space Mono', monospace;
    font-size: 28px;
    font-weight: 700;
    color: var(--accent);
  }

  .stat-label {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-top: 4px;
  }

  .btn-new {
    width: 100%;
    padding: 18px;
    border-radius: var(--radius);
    border: 2px dashed var(--border-accent);
    background: var(--accent-glow);
    color: var(--accent);
    font-family: 'DM Sans', sans-serif;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-bottom: 24px;
  }

  .btn-new:hover {
    background: var(--accent-glow-strong);
    border-color: var(--accent);
  }

  .section-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 12px;
  }

  /* Toast */
  .toast {
    position: fixed;
    bottom: -80px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--accent);
    color: var(--bg-primary);
    padding: 14px 28px;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: 14px;
    z-index: 999;
    transition: bottom 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 8px 32px rgba(0, 212, 170, 0.4);
  }

  .toast.show {
    bottom: 30px;
  }

  /* Modal overlay */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    z-index: 200;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .modal-overlay.show {
    display: flex;
  }

  .modal {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 28px;
    max-width: 400px;
    width: 100%;
    animation: fadeInUp 0.3s ease;
  }

  .modal h3 {
    font-size: 18px;
    margin-bottom: 10px;
  }

  .modal p {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 20px;
  }

  .modal-actions {
    display: flex;
    gap: 10px;
  }

  /* Responsive */
  @media (max-width: 420px) {
    .mallampati-grid { grid-template-columns: repeat(2, 1fr); }
    .asa-grid { grid-template-columns: repeat(2, 1fr); }
    .form-row, .form-row-3 { grid-template-columns: 1fr; }
    .step-label { font-size: 8px; }
  }
</style>
</head>
<body>

<!-- Header -->
<header class="header">
  <div class="header-content">
    <div class="logo">
      <div class="logo-icon">ü´Å</div>
      <div class="logo-text">Pre<span>Anestesia</span></div>
    </div>
    <div class="header-actions">
      <button class="header-btn" onclick="showHome()" title="In√≠cio">üè†</button>
      <button class="header-btn" onclick="exportAllData()" title="Exportar Dados">üì§</button>
    </div>
  </div>
</header>

<div class="container">

  <!-- HOME VIEW -->
  <div id="homeView">
    <div style="margin-top: 8px; margin-bottom: 24px;">
      <h1 style="font-size: 26px; font-weight: 700; letter-spacing: -0.5px;">Avalia√ß√£o<br>Pr√©-Anest√©sica</h1>
      <p style="color: var(--text-secondary); font-size: 14px; margin-top: 6px;">Coleta digital de dados pr√©-operat√≥rios</p>
    </div>

    <div class="home-stats">
      <div class="stat-card">
        <div class="stat-number" id="totalPatients">0</div>
        <div class="stat-label">Pacientes</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="todayPatients">0</div>
        <div class="stat-label">Hoje</div>
      </div>
    </div>

    <button class="btn-new" onclick="startNew()">
      <span style="font-size: 22px;">+</span> Nova Avalia√ß√£o
    </button>

    <div class="section-title">Avalia√ß√µes Recentes</div>
    <div id="patientsList"></div>
  </div>

  <!-- FORM VIEW -->
  <div id="formView" style="display: none;">

    <!-- Progress -->
    <div class="progress-container">
      <div class="progress-steps" id="progressSteps"></div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
    </div>

    <!-- STEP 1: Dados Pessoais -->
    <div class="step-view" id="step1">
      <div class="step-title">Dados Pessoais</div>
      <div class="step-subtitle">Informa√ß√µes b√°sicas do paciente</div>

      <div class="card">
        <div class="card-header">
          <div class="card-icon teal">üë§</div>
          <div class="card-title">Identifica√ß√£o</div>
        </div>
        <div class="form-group">
          <label class="form-label">Nome Completo</label>
          <input type="text" class="form-input" id="nome" placeholder="Nome do paciente">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Idade</label>
            <input type="number" class="form-input" id="idade" placeholder="Anos">
          </div>
          <div class="form-group">
            <label class="form-label">Sexo</label>
            <select class="form-select" id="sexo">
              <option value="">Selecione</option>
              <option>Masculino</option>
              <option>Feminino</option>
            </select>
          </div>
        </div>
        <div class="form-row-3">
          <div class="form-group">
            <label class="form-label">Peso (kg)</label>
            <input type="number" class="form-input" id="peso" placeholder="kg">
          </div>
          <div class="form-group">
            <label class="form-label">Altura (cm)</label>
            <input type="number" class="form-input" id="altura" placeholder="cm">
          </div>
          <div class="form-group">
            <label class="form-label">IMC</label>
            <input type="text" class="form-input" id="imc" placeholder="Auto" readonly style="color: var(--accent);">
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-icon blue">üìã</div>
          <div class="card-title">Procedimento</div>
        </div>
        <div class="form-group">
          <label class="form-label">Data do Procedimento</label>
          <input type="date" class="form-input" id="dataProcedimento">
        </div>
        <div class="form-group">
          <label class="form-label">Nome da Cirurgia</label>
          <input type="text" class="form-input" id="nomeCirurgia" placeholder="Ex: Colecistectomia videolaparosc√≥pica">
        </div>
      </div>
    </div>

    <!-- STEP 2: Hist√≥rico M√©dico -->
    <div class="step-view" id="step2">
      <div class="step-title">Hist√≥rico M√©dico</div>
      <div class="step-subtitle">Comorbidades e antecedentes</div>

      <div class="card">
        <div class="card-header">
          <div class="card-icon red">‚ù§Ô∏è</div>
          <div class="card-title">Comorbidades</div>
        </div>
        <div class="toggle-group" id="comorbidades">
          <div class="toggle-item" onclick="toggleItem(this)">
            <div class="toggle-check">‚úì</div>
            <div class="toggle-text">Hipertens√£o Arterial</div>
          </div>
          <div class="toggle-item" onclick="toggleItem(this)">
            <div class="toggle-check">‚úì</div>
            <div class="toggle-text">Diabetes Mellitus</div>
          </div>
          <div class="toggle-item" onclick="toggleItem(this)">
            <div class="toggle-check">‚úì</div>
            <div class="toggle-text">Cardiopatia</div>
          </div>
          <div class="toggle-item" onclick="toggleItem(this)">
            <div class="toggle-check">‚úì</div>
            <div class="toggle-text">Pneumopatia / Asma / DPOC</div>
          </div>
          <div class="toggle-item" onclick="toggleItem(this)">
            <div class="toggle-check">‚úì</div>
            <div class="toggle-text">Doen√ßa Renal</div>
          </div>
          <div class="toggle-item" onclick="toggleItem(this)">
            <div class="toggle-check">‚úì</div>
            <div class="toggle-text">Doen√ßa Hep√°tica</div>
          </div>
          <div class="toggle-item" onclick="toggleItem(this)">
            <div class="toggle-check">‚úì</div>
            <div class="toggle-text">Doen√ßa Neurol√≥gica</div>
          </div>
          <div class="toggle-item" onclick="toggleItem(this)">
            <div class="toggle-check">‚úì</div>
            <div class="toggle-text">Obesidade</div>
          </div>
          <div class="toggle-item" onclick="toggleItem(this)">
            <div class="toggle-check">‚úì</div>
            <div class="toggle-text">Tabagismo</div>
          </div>
          <div class="toggle-item" onclick="toggleItem(this)">
            <div class="toggle-check">‚úì</div>
            <div class="toggle-text">Etilismo</div>
          </div>
        </div>
        <div class="form-group" style="margin-top: 14px;">
          <label class="form-label">Outras Comorbidades</label>
          <input type="text" class="form-input" id="outrasComorbidades" placeholder="Especifique outras...">
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-icon orange">‚ö†Ô∏è</div>
          <div class="card-title">Antecedentes Anest√©sicos</div>
        </div>
        <div class="form-group">
          <label class="form-label">Cirurgias Anteriores</label>
          <textarea class="form-textarea" id="cirurgiasAnteriores" placeholder="Descreva cirurgias e anestesias pr√©vias..."></textarea>
        </div>
        <div class="toggle-group">
          <div class="toggle-item" onclick="toggleItem(this)" id="toggleIntDificil">
            <div class="toggle-check">‚úì</div>
            <div class="toggle-text">Hist√≥rico de intuba√ß√£o dif√≠cil</div>
          </div>
          <div class="toggle-item" onclick="toggleItem(this)" id="toggleReacaoAdversa">
            <div class="toggle-check">‚úì</div>
            <div class="toggle-text">Rea√ß√£o adversa √† anestesia pr√©via</div>
          </div>
        </div>
      </div>
    </div>

    <!-- STEP 3: Medica√ß√µes e Alergias -->
    <div class="step-view" id="step3">
      <div class="step-title">Medica√ß√µes & Alergias</div>
      <div class="step-subtitle">Medicamentos em uso e alergias conhecidas</div>

      <div class="card">
        <div class="card-header">
          <div class="card-icon blue">üíä</div>
          <div class="card-title">Medica√ß√µes em Uso</div>
        </div>
        <div class="form-group">
          <textarea class="form-textarea" id="medicacoes" placeholder="Liste as medica√ß√µes em uso cont√≠nuo, dosagem e posologia..." style="min-height: 120px;"></textarea>
        </div>
        <div class="toggle-group">
          <div class="toggle-item" onclick="toggleItem(this)" id="toggleAnticoag">
            <div class="toggle-check">‚úì</div>
            <div class="toggle-text">Uso de Anticoagulantes</div>
          </div>
          <div class="toggle-item" onclick="toggleItem(this)" id="toggleAntiag">
            <div class="toggle-check">‚úì</div>
            <div class="toggle-text">Uso de Antiplaquet√°rios</div>
          </div>
          <div class="toggle-item" onclick="toggleItem(this)" id="toggleInsulina">
            <div class="toggle-check">‚úì</div>
            <div class="toggle-text">Uso de Insulina</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-icon red">üö®</div>
          <div class="card-title">Alergias</div>
        </div>
        <div class="form-group">
          <textarea class="form-textarea" id="alergias" placeholder="Descreva alergias conhecidas (medicamentos, l√°tex, alimentos...)"></textarea>
        </div>
      </div>
    </div>

    <!-- STEP 4: Exame & Classifica√ß√£o -->
    <div class="step-view" id="step4">
      <div class="step-title">Via A√©rea & Classifica√ß√£o</div>
      <div class="step-subtitle">Mallampati, ASA e via a√©rea</div>

      <div class="card">
        <div class="card-header">
          <div class="card-icon teal">üëÑ</div>
          <div class="card-title">Classifica√ß√£o de Mallampati</div>
        </div>
        <div class="mallampati-grid" id="mallampatiGrid">
          <div class="mallampati-option" onclick="selectMallampati(this, 'I')">
            <div class="mallampati-visual">üü¢</div>
            <div class="mallampati-label">I</div>
            <div class="mallampati-desc">Palato mole, fauces, √∫vula, pilares</div>
          </div>
          <div class="mallampati-option" onclick="selectMallampati(this, 'II')">
            <div class="mallampati-visual">üü°</div>
            <div class="mallampati-label">II</div>
            <div class="mallampati-desc">Palato mole, fauces, √∫vula</div>
          </div>
          <div class="mallampati-option" onclick="selectMallampati(this, 'III')">
            <div class="mallampati-visual">üü†</div>
            <div class="mallampati-label">III</div>
            <div class="mallampati-desc">Palato mole, base da √∫vula</div>
          </div>
          <div class="mallampati-option" onclick="selectMallampati(this, 'IV')">
            <div class="mallampati-visual">üî¥</div>
            <div class="mallampati-label">IV</div>
            <div class="mallampati-desc">Apenas palato duro</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-icon orange">üìä</div>
          <div class="card-title">Classifica√ß√£o ASA</div>
        </div>
        <div class="asa-grid" id="asaGrid">
          <div class="asa-option" onclick="selectASA(this, 'I')">
            <div class="asa-number">I</div>
            <div class="asa-desc">Saud√°vel</div>
          </div>
          <div class="asa-option" onclick="selectASA(this, 'II')">
            <div class="asa-number">II</div>
            <div class="asa-desc">Doen√ßa sist√™mica leve</div>
          </div>
          <div class="asa-option" onclick="selectASA(this, 'III')">
            <div class="asa-number">III</div>
            <div class="asa-desc">Doen√ßa sist√™mica grave</div>
          </div>
          <div class="asa-option" onclick="selectASA(this, 'IV')">
            <div class="asa-number">IV</div>
            <div class="asa-desc">Amea√ßa constante √† vida</div>
          </div>
          <div class="asa-option" onclick="selectASA(this, 'V')">
            <div class="asa-number">V</div>
            <div class="asa-desc">Moribundo</div>
          </div>
          <div class="asa-option" onclick="selectASA(this, 'VI')">
            <div class="asa-number">VI</div>
            <div class="asa-desc">Morte encef√°lica</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-icon blue">üî¨</div>
          <div class="card-title">Exames Complementares</div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Hemoglobina (g/dL)</label>
            <input type="number" step="0.1" class="form-input" id="hemoglobina" placeholder="g/dL">
          </div>
          <div class="form-group">
            <label class="form-label">Hemat√≥crito (%)</label>
            <input type="number" step="0.1" class="form-input" id="hematocrito" placeholder="%">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Plaquetas (mil)</label>
            <input type="number" class="form-input" id="plaquetas" placeholder="mil/mm¬≥">
          </div>
          <div class="form-group">
            <label class="form-label">Creatinina (mg/dL)</label>
            <input type="number" step="0.01" class="form-input" id="creatinina" placeholder="mg/dL">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Glicemia (mg/dL)</label>
            <input type="number" class="form-input" id="glicemia" placeholder="mg/dL">
          </div>
          <div class="form-group">
            <label class="form-label">Coagulograma</label>
            <select class="form-select" id="coagulograma">
              <option value="">Selecione</option>
              <option>Normal</option>
              <option>Alterado</option>
              <option>N√£o realizado</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ECG</label>
          <select class="form-select" id="ecg">
            <option value="">Selecione</option>
            <option>Normal / Ritmo Sinusal</option>
            <option>Alterado</option>
            <option>N√£o realizado</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Observa√ß√µes sobre exames</label>
          <textarea class="form-textarea" id="obsExames" placeholder="Resultados relevantes, exames adicionais..."></textarea>
        </div>
      </div>
    </div>

    <!-- STEP 5: T√©cnica Anest√©sica -->
    <div class="step-view" id="step5">
      <div class="step-title">Plano Anest√©sico</div>
      <div class="step-subtitle">T√©cnica escolhida e observa√ß√µes finais</div>

      <div class="card">
        <div class="card-header">
          <div class="card-icon teal">üíâ</div>
          <div class="card-title">T√©cnica Anest√©sica</div>
        </div>
        <div class="toggle-group" id="tecnicaAnestesica">
          <div class="toggle-item" onclick="toggleItem(this)">
            <div class="toggle-check">‚úì</div>
            <div class="toggle-text">Anestesia Geral</div>
          </div>
          <div class="toggle-item" onclick="toggleItem(this)">
            <div class="toggle-check">‚úì</div>
            <div class="toggle-text">Raquianestesia</div>
          </div>
          <div class="toggle-item" onclick="toggleItem(this)">
            <div class="toggle-check">‚úì</div>
            <div class="toggle-text">Peridural</div>
          </div>
          <div class="toggle-item" onclick="toggleItem(this)">
            <div class="toggle-check">‚úì</div>
            <div class="toggle-text">Bloqueio de Nervo Perif√©rico</div>
          </div>
          <div class="toggle-item" onclick="toggleItem(this)">
            <div class="toggle-check">‚úì</div>
            <div class="toggle-text">Seda√ß√£o</div>
          </div>
          <div class="toggle-item" onclick="toggleItem(this)">
            <div class="toggle-check">‚úì</div>
            <div class="toggle-text">Anestesia Local</div>
          </div>
          <div class="toggle-item" onclick="toggleItem(this)">
            <div class="toggle-check">‚úì</div>
            <div class="toggle-text">Combinada (Geral + Regional)</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-icon orange">üìù</div>
          <div class="card-title">Observa√ß√µes / Plano</div>
        </div>
        <div class="form-group">
          <textarea class="form-textarea" id="observacoes" placeholder="Observa√ß√µes gerais, plano de monitoriza√ß√£o, cuidados especiais, jejum..." style="min-height: 120px;"></textarea>
        </div>
      </div>
    </div>

    <!-- STEP 6: Resumo -->
    <div class="step-view" id="step6">
      <div class="step-title">Resumo</div>
      <div class="step-subtitle">Revise os dados antes de salvar</div>

      <div class="card" id="summaryCard">
        <!-- Preenchido via JS -->
      </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="nav-buttons">
      <button class="btn btn-secondary" id="btnPrev" onclick="prevStep()">‚Üê Voltar</button>
      <button class="btn btn-primary" id="btnNext" onclick="nextStep()">Pr√≥ximo ‚Üí</button>
    </div>

  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal">
    <h3>Excluir Avalia√ß√£o?</h3>
    <p>Essa a√ß√£o n√£o pode ser desfeita.</p>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancelar</button>
      <button class="btn btn-danger" onclick="confirmDelete()">Excluir</button>
    </div>
  </div>
</div>

<script>
  // ========================
  // STATE
  // ========================
  let currentStep = 1;
  const totalSteps = 6;
  let patients = JSON.parse(localStorage.getItem('preanestesia_patients') || '[]');
  let editingId = null;
  let deletingId = null;

  const stepNames = ['Pessoal', 'Hist√≥rico', 'Medica√ß√µes', 'Exames', 'T√©cnica', 'Resumo'];

  // ========================
  // INIT
  // ========================
  function init() {
    renderProgressSteps();
    renderPatientsList();
    updateStats();
    setupIMCCalc();
  }

  function setupIMCCalc() {
    document.getElementById('peso').addEventListener('input', calcIMC);
    document.getElementById('altura').addEventListener('input', calcIMC);
  }

  function calcIMC() {
    const peso = parseFloat(document.getElementById('peso').value);
    const altura = parseFloat(document.getElementById('altura').value) / 100;
    if (peso > 0 && altura > 0) {
      const imc = (peso / (altura * altura)).toFixed(1);
      document.getElementById('imc').value = imc;
    } else {
      document.getElementById('imc').value = '';
    }
  }

  // ========================
  // PROGRESS
  // ========================
  function renderProgressSteps() {
    const container = document.getElementById('progressSteps');
    container.innerHTML = '';
    for (let i = 1; i <= totalSteps; i++) {
      const step = document.createElement('div');
      step.className = `progress-step ${i === currentStep ? 'active' : ''} ${i < currentStep ? 'completed' : ''}`;
      step.onclick = () => goToStep(i);
      step.innerHTML = `
        <div class="step-dot">${i < currentStep ? '‚úì' : i}</div>
        <div class="step-label">${stepNames[i-1]}</div>
      `;
      container.appendChild(step);
    }
    document.getElementById('progressFill').style.width = `${((currentStep - 1) / (totalSteps - 1)) * 100}%`;
  }

  function updateNavButtons() {
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    btnPrev.style.display = currentStep === 1 ? 'none' : 'flex';

    if (currentStep === totalSteps) {
      btnNext.textContent = 'üíæ Salvar';
      btnNext.onclick = savePatient;
    } else {
      btnNext.innerHTML = 'Pr√≥ximo ‚Üí';
      btnNext.onclick = nextStep;
    }
  }

  // ========================
  // NAVIGATION
  // ========================
  function showHome() {
    document.getElementById('homeView').style.display = 'block';
    document.getElementById('formView').style.display = 'none';
    editingId = null;
    renderPatientsList();
    updateStats();
  }

  function showForm() {
    document.getElementById('homeView').style.display = 'none';
    document.getElementById('formView').style.display = 'block';
    currentStep = 1;
    updateStepViews();
  }

  function startNew() {
    clearForm();
    editingId = null;
    showForm();
  }

  function goToStep(step) {
    if (step >= 1 && step <= totalSteps) {
      currentStep = step;
      if (currentStep === totalSteps) renderSummary();
      updateStepViews();
    }
  }

  function nextStep() {
    if (currentStep < totalSteps) {
      currentStep++;
      if (currentStep === totalSteps) renderSummary();
      updateStepViews();
    }
  }

  function prevStep() {
    if (currentStep > 1) {
      currentStep--;
      updateStepViews();
    }
  }

  function updateStepViews() {
    document.querySelectorAll('.step-view').forEach((el, i) => {
      el.classList.toggle('active', i + 1 === currentStep);
    });
    renderProgressSteps();
    updateNavButtons();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // ========================
  // TOGGLES
  // ========================
  function toggleItem(el) {
    el.classList.toggle('selected');
  }

  let selectedMallampati = '';
  function selectMallampati(el, val) {
    document.querySelectorAll('#mallampatiGrid .mallampati-option').forEach(o => o.classList.remove('selected'));
    el.classList.add('selected');
    selectedMallampati = val;
  }

  let selectedASA = '';
  function selectASA(el, val) {
    document.querySelectorAll('#asaGrid .asa-option').forEach(o => o.classList.remove('selected'));
    el.classList.add('selected');
    selectedASA = val;
  }

  // ========================
  // COLLECT DATA
  // ========================
  function getSelectedToggles(containerId) {
    return [...document.querySelectorAll(`#${containerId} .toggle-item.selected`)]
      .map(el => el.querySelector('.toggle-text').textContent.trim());
  }

  function collectData() {
    return {
      id: editingId || Date.now().toString(),
      timestamp: new Date().toISOString(),
      nome: document.getElementById('nome').value,
      idade: document.getElementById('idade').value,
      sexo: document.getElementById('sexo').value,
      peso: document.getElementById('peso').value,
      altura: document.getElementById('altura').value,
      imc: document.getElementById('imc').value,
      dataProcedimento: document.getElementById('dataProcedimento').value,
      nomeCirurgia: document.getElementById('nomeCirurgia').value,
      comorbidades: getSelectedToggles('comorbidades'),
      outrasComorbidades: document.getElementById('outrasComorbidades').value,
      cirurgiasAnteriores: document.getElementById('cirurgiasAnteriores').value,
      intubacaoDificil: document.getElementById('toggleIntDificil').classList.contains('selected'),
      reacaoAdversa: document.getElementById('toggleReacaoAdversa').classList.contains('selected'),
      medicacoes: document.getElementById('medicacoes').value,
      anticoagulantes: document.getElementById('toggleAnticoag').classList.contains('selected'),
      antiplaquetarios: document.getElementById('toggleAntiag').classList.contains('selected'),
      insulina: document.getElementById('toggleInsulina').classList.contains('selected'),
      alergias: document.getElementById('alergias').value,
      mallampati: selectedMallampati,
      asa: selectedASA,
      hemoglobina: document.getElementById('hemoglobina').value,
      hematocrito: document.getElementById('hematocrito').value,
      plaquetas: document.getElementById('plaquetas').value,
      creatinina: document.getElementById('creatinina').value,
      glicemia: document.getElementById('glicemia').value,
      coagulograma: document.getElementById('coagulograma').value,
      ecg: document.getElementById('ecg').value,
      obsExames: document.getElementById('obsExames').value,
      tecnicaAnestesica: getSelectedToggles('tecnicaAnestesica'),
      observacoes: document.getElementById('observacoes').value
    };
  }

  // ========================
  // SAVE
  // ========================
  function savePatient() {
    const data = collectData();
    if (!data.nome) {
      showToast('‚ö†Ô∏è Informe o nome do paciente');
      goToStep(1);
      return;
    }

    if (editingId) {
      const idx = patients.findIndex(p => p.id === editingId);
      if (idx !== -1) patients[idx] = data;
    } else {
      patients.unshift(data);
    }

    localStorage.setItem('preanestesia_patients', JSON.stringify(patients));
    showToast('‚úÖ Avalia√ß√£o salva com sucesso!');
    showHome();
  }

  // ========================
  // LOAD INTO FORM
  // ========================
  function loadPatient(id) {
    const p = patients.find(pt => pt.id === id);
    if (!p) return;
    editingId = id;

    document.getElementById('nome').value = p.nome || '';
    document.getElementById('idade').value = p.idade || '';
    document.getElementById('sexo').value = p.sexo || '';
    document.getElementById('peso').value = p.peso || '';
    document.getElementById('altura').value = p.altura || '';
    document.getElementById('imc').value = p.imc || '';
    document.getElementById('dataProcedimento').value = p.dataProcedimento || '';
    document.getElementById('nomeCirurgia').value = p.nomeCirurgia || '';
    document.getElementById('outrasComorbidades').value = p.outrasComorbidades || '';
    document.getElementById('cirurgiasAnteriores').value = p.cirurgiasAnteriores || '';
    document.getElementById('medicacoes').value = p.medicacoes || '';
    document.getElementById('alergias').value = p.alergias || '';
    document.getElementById('hemoglobina').value = p.hemoglobina || '';
    document.getElementById('hematocrito').value = p.hematocrito || '';
    document.getElementById('plaquetas').value = p.plaquetas || '';
    document.getElementById('creatinina').value = p.creatinina || '';
    document.getElementById('glicemia').value = p.glicemia || '';
    document.getElementById('coagulograma').value = p.coagulograma || '';
    document.getElementById('ecg').value = p.ecg || '';
    document.getElementById('obsExames').value = p.obsExames || '';
    document.getElementById('observacoes').value = p.observacoes || '';

    // Restore comorbidades
    document.querySelectorAll('#comorbidades .toggle-item').forEach(el => {
      const txt = el.querySelector('.toggle-text').textContent.trim();
      el.classList.toggle('selected', (p.comorbidades || []).includes(txt));
    });

    // Restore toggles
    document.getElementById('toggleIntDificil').classList.toggle('selected', !!p.intubacaoDificil);
    document.getElementById('toggleReacaoAdversa').classList.toggle('selected', !!p.reacaoAdversa);
    document.getElementById('toggleAnticoag').classList.toggle('selected', !!p.anticoagulantes);
    document.getElementById('toggleAntiag').classList.toggle('selected', !!p.antiplaquetarios);
    document.getElementById('toggleInsulina').classList.toggle('selected', !!p.insulina);

    // Mallampati
    selectedMallampati = p.mallampati || '';
    document.querySelectorAll('#mallampatiGrid .mallampati-option').forEach(el => {
      const val = el.querySelector('.mallampati-label').textContent;
      el.classList.toggle('selected', val === selectedMallampati);
    });

    // ASA
    selectedASA = p.asa || '';
    document.querySelectorAll('#asaGrid .asa-option').forEach(el => {
      const val = el.querySelector('.asa-number').textContent;
      el.classList.toggle('selected', val === selectedASA);
    });

    // T√©cnica
    document.querySelectorAll('#tecnicaAnestesica .toggle-item').forEach(el => {
      const txt = el.querySelector('.toggle-text').textContent.trim();
      el.classList.toggle('selected', (p.tecnicaAnestesica || []).includes(txt));
    });

    showForm();
  }

  // ========================
  // CLEAR FORM
  // ========================
  function clearForm() {
    document.querySelectorAll('.form-input, .form-textarea').forEach(el => el.value = '');
    document.querySelectorAll('.form-select').forEach(el => el.selectedIndex = 0);
    document.querySelectorAll('.toggle-item').forEach(el => el.classList.remove('selected'));
    document.querySelectorAll('.mallampati-option, .asa-option').forEach(el => el.classList.remove('selected'));
    selectedMallampati = '';
    selectedASA = '';
  }

  // ========================
  // SUMMARY
  // ========================
  function renderSummary() {
    const d = collectData();
    const card = document.getElementById('summaryCard');

    const formatDate = (str) => {
      if (!str) return '‚Äî';
      const [y, m, day] = str.split('-');
      return `${day}/${m}/${y}`;
    };

    let html = `
      <div class="summary-section">
        <div class="summary-label">Paciente</div>
        <div class="summary-value" style="font-size: 18px; font-weight: 700;">${d.nome || '‚Äî'}</div>
        <div class="summary-value">${d.idade ? d.idade + ' anos' : ''} ${d.sexo ? '¬∑ ' + d.sexo : ''} ${d.peso ? '¬∑ ' + d.peso + 'kg' : ''} ${d.altura ? '¬∑ ' + d.altura + 'cm' : ''} ${d.imc ? '¬∑ IMC ' + d.imc : ''}</div>
      </div>
      <hr class="summary-divider">
      <div class="summary-section">
        <div class="summary-label">Procedimento</div>
        <div class="summary-value">${d.nomeCirurgia || '‚Äî'}</div>
        <div class="summary-value" style="color: var(--text-secondary);">${formatDate(d.dataProcedimento)}</div>
      </div>
      <hr class="summary-divider">
      <div class="summary-section">
        <div class="summary-label">Classifica√ß√£o</div>
        <div style="display: flex; gap: 16px; margin-top: 4px;">
          <div>
            <div class="summary-value highlight">ASA ${d.asa || '‚Äî'}</div>
          </div>
          <div>
            <div class="summary-value highlight">Mallampati ${d.mallampati || '‚Äî'}</div>
          </div>
        </div>
      </div>
      <hr class="summary-divider">
    `;

    if (d.comorbidades.length > 0 || d.outrasComorbidades) {
      html += `<div class="summary-section"><div class="summary-label">Comorbidades</div>`;
      d.comorbidades.forEach(c => html += `<span class="summary-tag">${c}</span>`);
      if (d.outrasComorbidades) html += `<span class="summary-tag">${d.outrasComorbidades}</span>`;
      html += `</div><hr class="summary-divider">`;
    }

    if (d.intubacaoDificil || d.reacaoAdversa) {
      html += `<div class="summary-section"><div class="summary-label">‚ö†Ô∏è Alertas</div>`;
      if (d.intubacaoDificil) html += `<span class="summary-tag red">Intuba√ß√£o Dif√≠cil</span>`;
      if (d.reacaoAdversa) html += `<span class="summary-tag red">Rea√ß√£o Adversa Pr√©via</span>`;
      html += `</div><hr class="summary-divider">`;
    }

    if (d.medicacoes) {
      html += `<div class="summary-section"><div class="summary-label">Medica√ß√µes</div><div class="summary-value">${d.medicacoes}</div>`;
      if (d.anticoagulantes) html += `<span class="summary-tag red">Anticoagulante</span>`;
      if (d.antiplaquetarios) html += `<span class="summary-tag red">Antiplaquet√°rio</span>`;
      if (d.insulina) html += `<span class="summary-tag">Insulina</span>`;
      html += `</div><hr class="summary-divider">`;
    }

    if (d.alergias) {
      html += `<div class="summary-section"><div class="summary-label">üö® Alergias</div><div class="summary-value">${d.alergias}</div></div><hr class="summary-divider">`;
    }

    // Exames
    let exames = [];
    if (d.hemoglobina) exames.push(`Hb: ${d.hemoglobina} g/dL`);
    if (d.hematocrito) exames.push(`Ht: ${d.hematocrito}%`);
    if (d.plaquetas) exames.push(`Plaq: ${d.plaquetas} mil`);
    if (d.creatinina) exames.push(`Cr: ${d.creatinina} mg/dL`);
    if (d.glicemia) exames.push(`Glic: ${d.glicemia} mg/dL`);
    if (d.coagulograma) exames.push(`Coag: ${d.coagulograma}`);
    if (d.ecg) exames.push(`ECG: ${d.ecg}`);

    if (exames.length) {
      html += `<div class="summary-section"><div class="summary-label">Exames</div><div class="summary-value">${exames.join(' ¬∑ ')}</div></div><hr class="summary-divider">`;
    }

    if (d.tecnicaAnestesica.length) {
      html += `<div class="summary-section"><div class="summary-label">T√©cnica Anest√©sica</div>`;
      d.tecnicaAnestesica.forEach(t => html += `<span class="summary-tag">${t}</span>`);
      html += `</div>`;
    }

    if (d.observacoes) {
      html += `<hr class="summary-divider"><div class="summary-section"><div class="summary-label">Observa√ß√µes</div><div class="summary-value">${d.observacoes}</div></div>`;
    }

    card.innerHTML = html;
  }

  // ========================
  // PATIENTS LIST
  // ========================
  function renderPatientsList() {
    const container = document.getElementById('patientsList');
    if (patients.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">üìã</div>
          <div class="empty-text">Nenhuma avalia√ß√£o registrada</div>
        </div>
      `;
      return;
    }

    container.innerHTML = patients.map(p => `
      <div class="patient-item" onclick="loadPatient('${p.id}')">
        <div class="patient-info">
          <h4>${p.nome || 'Sem nome'}</h4>
          <p>${p.nomeCirurgia || 'Sem procedimento'} ¬∑ ${p.dataProcedimento ? formatDateShort(p.dataProcedimento) : '‚Äî'}</p>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div class="patient-asa">ASA ${p.asa || '?'}</div>
          <button class="header-btn" style="width: 32px; height: 32px; font-size: 13px;" onclick="event.stopPropagation(); openDeleteModal('${p.id}')">üóë</button>
        </div>
      </div>
    `).join('');
  }

  function formatDateShort(str) {
    if (!str) return '';
    const [y, m, d] = str.split('-');
    return `${d}/${m}`;
  }

  function updateStats() {
    document.getElementById('totalPatients').textContent = patients.length;
    const today = new Date().toISOString().split('T')[0];
    const todayCount = patients.filter(p => p.dataProcedimento === today).length;
    document.getElementById('todayPatients').textContent = todayCount;
  }

  // ========================
  // DELETE
  // ========================
  function openDeleteModal(id) {
    deletingId = id;
    document.getElementById('deleteModal').classList.add('show');
  }

  function closeDeleteModal() {
    deletingId = null;
    document.getElementById('deleteModal').classList.remove('show');
  }

  function confirmDelete() {
    patients = patients.filter(p => p.id !== deletingId);
    localStorage.setItem('preanestesia_patients', JSON.stringify(patients));
    closeDeleteModal();
    renderPatientsList();
    updateStats();
    showToast('üóë Avalia√ß√£o exclu√≠da');
  }

  // ========================
  // EXPORT
  // ========================
  function exportAllData() {
    if (patients.length === 0) {
      showToast('‚ö†Ô∏è Nenhum dado para exportar');
      return;
    }
    const dataStr = JSON.stringify(patients, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `preanestesia_backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('üì§ Dados exportados!');
  }

  // ========================
  // TOAST
  // ========================
  function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2500);
  }

  // ========================
  // INIT
  // ========================
  init();
</script>

</body>
</html>
